# -*- coding: utf-8 -*-
"""bigdataproject_20192740_jidaewoong.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1f4cGn9B-oNYkVBnQUjf3ywPINFEcc8Ph
"""

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

from matplotlib import rc

"""**λ°μ΄ν„° μ„¤λ…**"""

df = pd.read_csv('ν•κµ­μ „λ ¥κ³µμ‚¬_μ„μΈμ‹ μ „κΈ°μ°¨μ¶©μ „μ† μ¶©μ „λ‰.csv', encoding= 'utf-8')
df

"""**μ „μ²λ¦¬ κ³Όμ •**"""

df.info()

"""κ²°μΈ΅μΉ μ²λ¦¬, λ‚ μ§μ—΄ λ³€ν™"""

df['μ¶©μ „κΈ°μ©λ‰'].value_counts(dropna=False)/len(df)

fill_values = { 'κΈ‰μ†': 50, 'μ™„μ†': 7 }
fill_func = lambda g : g.fillna(fill_values[g.name])
df= df.groupby('μ¶©μ „κµ¬λ¶„').apply(fill_func)

df.isnull().sum()

"""**μ£Όμ†μ—΄ μ΄μƒμΉ λ€μ²΄**"""

df['μ£Όμ†'].value_counts()
df = df.replace('μ„μΈνΉλ³„μ‹ null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null', np.nan)

df[df['μ£Όμ†'].isnull()]['μ¶©μ „μ†λ…'].value_counts()

#μΈν„°λ„·μ—μ„ μ£Όμ†λ¥Ό μ°Ύμ•„ λ„£μµλ‹λ‹¤
for i,j in enumerate(df['μ¶©μ „μ†λ…']) :
  if j == 'λ™λ€λ¬Έλ””μμΈν”λΌμ' :
    df['μ£Όμ†'][i] = 'μ„μΈνΉλ³„μ‹ μ¤‘κµ¬ μ„μ§€λ΅ 281'
  elif j == 'λ°©λ°°λ΅―λ°μΊμ¬μ•„λ¥΄λ–Ό' :
    df['μ£Όμ†'][i] = 'μ„μΈνΉλ³„μ‹ μ„μ΄κµ¬ λ°©λ°°μ²λ΅18κΈΈ 11'
  elif j == 'κµ­λ¦½ν„λ€λ―Έμ κ΄€ μ„μΈκ΄€' :
    df['μ£Όμ†'][i] = 'μ„μΈνΉλ³„μ‹ μΆ…λ΅κµ¬ μ‚Όμ²­λ΅ 30'
  elif j == 'μ–‘μ¬λ¦¬λ³Ένƒ€μ›2λ‹¨μ§€μ•„ννΈ' :
    df['μ£Όμ†'][i] = 'μ„μΈνΉλ³„μ‹ μ„μ΄κµ¬ μ–‘μ¬λ™ 212'

df['μ£Όμ†'].isnull().sum()

"""μ§€μ¤μ½”λ“ ν™μ©"""

lat = pd.read_csv('ad.csv')

lat = lat[lat['μ£Όμ†'].str.split().str[0]!='κ²½κΈ°λ„']
lat = lat.drop(0)
lat

"""**μ„μΈμ‹ κµ¬ μ—΄ μƒμ„±**"""

df['μ£Όμ†']= df['μ£Όμ†'].str.replace('μ„μΈνΉλ³„μ‹ ','')
df.insert(3, 'μ£Όμ†_κµ¬', df['μ£Όμ†'].str.split().str[0])
df.head()

"""**μ¶©μ „λ‰, μ¶©μ „μ‹κ°„ μ΄μƒμΉ μ²λ¦¬**"""

df.groupby('μ¶©μ „κµ¬λ¶„').describe().T

slow = df[df['μ¶©μ „κµ¬λ¶„']=='μ™„μ†']
slow['μ¶©μ „λ‰'].clip(0,25.81,inplace=True)
slow['μ¶©μ „μ‹κ°„'].clip(0,5,inplace=True)
fast = df[df['μ¶©μ „κµ¬λ¶„']=='κΈ‰μ†']
fast['μ¶©μ „μ‹κ°„'].clip(0,1,inplace = True)

df = pd.concat([fast,slow]).reset_index(drop=True) ;df

"""**μ΄ μ¶©μ „μ‹κ°„ μ—΄ μƒμ„±**"""

df.insert(6, 'μ΄μ¶©μ „μ‹κ°„', ((df['μ¶©μ „μ‹κ°„']*60) + df['μ¶©μ „λ¶„'])/60)

df['μ΄μ¶©μ „μ‹κ°„'] = round(df['μ΄μ¶©μ „μ‹κ°„'],2) ;df

!pip install streamlit

!pip install pyngrok

"""**ν™νμ΄μ§€ μ μ‘**

"""

df.to_csv('data')
df.to_csv('data.csv', index=False)

# Read DataFrame from CSV
df = pd.read_csv('data.csv', encoding='utf-8-sig')

# Display DataFrame information before conversion
st.write("DataFrame info before conversion:")
st.write(df.info())

# Change start time and end time to datetime
df['μ¶©μ „μ‹μ‘μ‹κ°'] = pd.to_datetime(df['μ¶©μ „μ‹μ‘μ‹κ°'], format='%Y-%m-%d %H:%M:%S', errors='coerce')
df['μ¶©μ „μΆ…λ£μ‹κ°'] = pd.to_datetime(df['μ¶©μ „μΆ…λ£μ‹κ°'], format='%Y-%m-%d %H:%M:%S', errors='coerce')

# Display DataFrame information after conversion
st.write("\nDataFrame info after conversion:")
st.write(df.info())

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import streamlit as st
from datetime import date

df['year'] = df['μ¶©μ „μ‹μ‘μ‹κ°'].dt.year
c = df['year'] == 2021

df_simple = df.loc[c,:]

#month week weekday μ—΄ λ§λ“¤μ–΄μ£ΌκΈ°

df_simple['month'] = df_simple['μ¶©μ „μ‹μ‘μ‹κ°'].dt.month
df_simple['week'] = (np.floor( (df_simple['μ¶©μ „μ‹μ‘μ‹κ°'].dt.dayofyear) / 7 ))
df_simple['week'].astype('int')
df_simple['day'] = df_simple['μ¶©μ „μ‹μ‘μ‹κ°'].dt.dayofyear

df_simple.head()

df_simple = df_simple.rename(columns={'Latitude':'lat','Longitude':'lon'})

#ν™νμ΄μ§€ μ΄λ¦„ μ •ν•κΈ°
st.set_page_config(page_title = 'Streamlit Homepage', page_icon = 'π—',
                      layout = 'wide')

#νƒ€μ΄ν‹€ μ μ–΄μ£ΌκΈ°
st.title('Data App Dashboard')

#μƒλ΅κ³ μΉ¨ λ²„νΌ λ§λ“¤κΈ°
if st.button('μƒλ΅κ³ μΉ¨'):
    st.experimental_rerun()

st.sidebar.title("μ΅°κ±΄ ν•„ν„°")
st.sidebar.header("λ‚ μ§ μ΅°κ±΄")
col1, col2 = st.sidebar.columns(2)
with col1:
    start_date = st.date_input("μ‹μ‘μΌμ‹", date(2021, 1, 1),
                                       min_value=date(2021,1,1),
                                       max_value=date(2021,12,31))
with col2:
    end_date = st.date_input("μΆ…λ£μΌμ‹", date(2021, 12, 31),
                                     min_value=date(2021,1,1),
                                     max_value=date(2021,12,31))
df_simple = df_simple[df_simple['μ¶©μ „μ‹μ‘μ‹κ°'].dt.date.between(start_date, end_date)]


st.sidebar.header('μ¶©μ „κΈ°')
option01 = st.sidebar.multiselect('μ¶©μ „κµ¬λ¶„', (df_simple.μ¶©μ „κµ¬λ¶„.unique()), default=(df_simple.μ¶©μ „κµ¬λ¶„.unique()))
df_simple = df_simple[df_simple.μ¶©μ „κµ¬λ¶„.isin(option01)]
option02 = st.sidebar.multiselect('μ¶©μ „κΈ°μ©λ‰', (df_simple.μ¶©μ „κΈ°μ©λ‰.unique()), default=(df_simple.μ¶©μ „κΈ°μ©λ‰.unique()))
df_simple = df_simple[df_simple.μ¶©μ „κΈ°μ©λ‰.isin(option02)]

st.sidebar.header('μ§€μ—­κµ¬ μ„ νƒ')
option03 = st.sidebar.multiselect('μ§€μ—­κµ¬', (df_simple.μ£Όμ†_κµ¬.unique()), default=(df.μ£Όμ†_κµ¬.unique()))
df_simple= df_simple[df_simple.μ£Όμ†_κµ¬.isin(option03)]

st.sidebar.header('μ¶©μ „μ‹κ°„')
option04 = st.sidebar.slider('μ¶©μ „μ‹κ°„',0.0,6.0,(0.0,6.0))

df_simple = df_simple[(option04[1] >= df_simple.μ΄μ¶©μ „μ‹κ°„) & (option04[0] <= df_simple.μ΄μ¶©μ „μ‹κ°„) ]

df_simple

#header λ§λ“¤κΈ° Overview
st.header('0. Overview')
col1, col2 = st.columns(2)
col1.metric(label = "ν‰κ·  μ¶©μ „λ‰", value = round(df_simple['μ¶©μ „λ‰'].mean() ,2))
col2.metric(label = "ν‰κ·  μ¶©μ „μ‹κ°„", value = round(df_simple['μ΄μ¶©μ „μ‹κ°„'].mean() ,2))

st.header('1. μ¶©μ „λ‰ λ¶„μ„')

st.subheader('μ „μ²΄')

time_frame = st.selectbox("μ›” λ‹¨μ„/μ£Ό λ‹¨μ„/μΌ λ‹¨μ„", ("month", "week","day"))

whole_values = df_simple.groupby(time_frame)[['μ¶©μ „λ‰']].sum()

st.download_button('Download',whole_values.to_csv(encoding='euc-kr'), 'μ¶©μ „λ‰ λ¶„μ„.csv')

st.area_chart(whole_values, use_container_width=True)

st.subheader('μ§€μ—­λ³„ λΉ„κµ')


city_range = st.radio(label="λ²”μ„μ„ νƒ", options=("κµ¬λ‹¨μ„", ""), index=0)


if city_range=='κµ¬λ‹¨μ„':
    city_range='μ£Όμ†_κµ¬'
    small_region = st.multiselect("κµ¬μ„ νƒ", (df_simple.μ£Όμ†_κµ¬.unique()), (df_simple.μ£Όμ†_κµ¬.unique()))
    city_values = df_simple[df_simple['μ£Όμ†_κµ¬'].isin(small_region)]


    city_values = pd.pivot_table(city_values, index=time_frame, columns=city_range,
                             values='μ¶©μ „λ‰', aggfunc='sum',fill_value=0)
    city_values.index.name = None
    city_values.columns = list(city_values.columns)

    st.line_chart(city_values, use_container_width=True)

st.subheader('Top5 λΉ„κµ')

def top5(col_name, top=5):
    my_agg = (df_simple.groupby(col_name)['μ¶©μ „λ‰'].sum()).reset_index().sort_values('μ¶©μ „λ‰', ascending=False).head(top)
    my_agg[col_name] = my_agg[col_name].astype('str')
    fig = plt.figure(figsize=(15,10))
    ax = sns.barplot(x='μ¶©μ „λ‰', y=col_name, data=my_agg)
    #ax.bar_label(ax.containers[0], label_type='center', color='white')
    return fig

col1, col2 = st.columns(2)
with col1:
    st.write('Top5 μ¶©μ „λ‰')
    st.pyplot(top5('μ£Όμ†_κµ¬'))
with col2:
    st.write('Top5 μ¶©μ „λ‰')
    st.pyplot(top5('μ¶©μ „μ†λ…'))

st.header('2. μ¶©μ „μ‹κ°„λ¶„μ„')

st.subheader('μ „μ²΄')

time_frame2 = st.selectbox("μ›”λ‹¨μ„/μ£Όλ‹¨μ„/μΌλ‹¨μ„", ("month", "week","day"))

whole_values2 = df_simple.groupby(time_frame2)[['μ΄μ¶©μ „μ‹κ°„']].mean()

st.download_button('Download',whole_values2.to_csv(encoding='euc-kr'), 'μ΄μ¶©μ „μ‹κ°„ λ¶„μ„.csv')

st.area_chart(whole_values2, use_container_width=True)

st.subheader('μ§€μ—­λ³„ λΉ„κµ')


city_range = st.radio(label="λ²”μ„μ„ νƒ", options=("κµ¬ λ‹¨μ„", " "), index=0)


if city_range=='κµ¬λ‹¨μ„':
    city_range='μ£Όμ†_κµ¬'
    small_region = st.multiselect("κµ¬μ„ νƒ", (df_simple.μ£Όμ†_κµ¬.unique()), (df_simple.μ£Όμ†_κµ¬.unique()))
    city_values = df_simple[df_simple['μ£Όμ†_κµ¬'].isin(small_region)]


    city_values = pd.pivot_table(city_values, index=time_frame2, columns=city_range,
                             values='μ΄μ¶©μ „μ‹κ°„', aggfunc='mean',fill_value=0)
    city_values.index.name = None
    city_values.columns = list(city_values.columns)

    st.line_chart(city_values, use_container_width=True)

st.subheader('Top5 λΉ„κµ')

def top5(col_name, top=5):
    my_agg = (df_simple.groupby(col_name)['μ΄μ¶©μ „μ‹κ°„'].mean()).reset_index().sort_values('μ΄μ¶©μ „μ‹κ°„', ascending=False).head(top)
    my_agg[col_name] = my_agg[col_name].astype('str')
    fig = plt.figure(figsize=(15,10))
    ax = sns.barplot(x='μ΄μ¶©μ „μ‹κ°„', y=col_name, data=my_agg)
    #ax.bar_label(ax.containers[0], label_type='center', color='white')
    return fig

col1, col2 = st.columns(2)
with col1:
    st.write('Top5 μ¶©μ „μ‹κ°„')
    st.pyplot(top5('μ£Όμ†_κµ¬'))
with col2:
    st.write('Top5 μ¶©μ „μ‹κ°„')
    st.pyplot(top5('μ¶©μ „μ†λ…'))


# In[18]:


st.subheader('μ§€μ—­λ³„λ¶„ν¬')

jit = np.random.randn(len(df_simple), 2)
jit_ratio = 0.001
df_simple['lat'] = df_simple.get('lat', 0) + jit[:, 0] * jit_ratio
df_simple['lon'] = df_simple.get('lon', 0) + jit[:, 1] * jit_ratio
st.map(df_simple)

